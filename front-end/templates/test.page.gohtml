{{/* Interactive test page that exercises broker actions. */}}
{{template "base" .}}

{{define "content" }}
    <div class="page-shell">
        <header class="hero">
            <div>
                <h1 class="headline">Microservice Control Room</h1>
                <p class="subhead">Trigger broker workflows and inspect payloads in real time.</p>
            </div>
            <div class="service-pill">
                <span>Broker</span>
                <code>{{.BrokerURL}}</code>
            </div>
        </header>

        <section class="actions" aria-label="Service actions">
            <button id="brokerBtn" class="action-btn" type="button">Ping broker</button>
            <button id="authBrokerBtn" class="action-btn" type="button">Run auth flow</button>
            <button id="logBtn" class="action-btn" type="button">Write log (RPC)</button>
            <button id="mailBtn" class="action-btn" type="button">Send mail</button>
            <button id="logGrpc" class="action-btn" type="button">Write log (gRPC)</button>
        </section>

        <section class="panel">
            <h2 class="panel-title">Activity</h2>
            <div id="output" class="panel-body">
                <span class="placeholder">Run an action to see status updates.</span>
            </div>
        </section>

        <section class="surface-grid">
            <article class="panel">
                <h3 class="panel-title">Sent payload</h3>
                <div class="panel-body">
                    <pre id="payload"><span class="placeholder">Nothing sent yet.</span></pre>
                </div>
            </article>
            <article class="panel">
                <h3 class="panel-title">Received payload</h3>
                <div class="panel-body">
                    <pre id="received"><span class="placeholder">Nothing received yet.</span></pre>
                </div>
            </article>
        </section>
    </div>
{{end}}

{{define "js"}}
    <script>
        const brokerBtn = document.getElementById('brokerBtn')
        const authBrokerBtn = document.getElementById('authBrokerBtn')
        const logBtn = document.getElementById('logBtn')
        const mailBtn = document.getElementById('mailBtn')
        const logGrpcBtn = document.getElementById('logGrpc')

        const output = document.getElementById('output')
        const sent = document.getElementById('payload')
        const received = document.getElementById('received')

        const brokerURL = "{{.BrokerURL}}".replace(/\/+$/, "")

        function setPayloadView(target, value) {
            if (typeof value === 'string') {
                target.textContent = value
                return
            }

            target.textContent = JSON.stringify(value, null, 4)
        }

        function appendOutput(source, message, isError = false) {
            const placeholder = output.querySelector('.placeholder')
            if (placeholder) {
                placeholder.remove()
            }

            const row = document.createElement('div')
            row.className = `log-entry ${isError ? 'is-error' : 'is-success'}`

            const label = document.createElement('span')
            label.className = 'log-label'
            label.textContent = `${source}:`

            const text = document.createElement('span')
            text.textContent = message

            row.append(label, text)
            output.appendChild(row)
        }

        async function postJSON(path, payload) {
            const request = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }

            if (payload) {
                request.body = JSON.stringify(payload)
            }

            const response = await fetch(`${brokerURL}${path}`, request)

            try {
                return await response.json()
            } catch (error) {
                return {
                    error: true,
                    message: `invalid JSON response (${response.status})`
                }
            }
        }

        brokerBtn.addEventListener('click', async function () {
            try {
                const data = await postJSON('', null)

                setPayloadView(sent, 'Empty POST request')
                setPayloadView(received, data)

                if (data.error) {
                    appendOutput('Broker', data.message, true)
                    return
                }

                appendOutput('Broker', data.message)
            } catch (error) {
                appendOutput('Error', error.message, true)
            }
        })

        authBrokerBtn.addEventListener('click', async function () {
            const payload = {
                action: 'auth',
                auth: {
                    email: 'admin@example.com',
                    password: 'verysecret'
                }
            }

            try {
                const data = await postJSON('/handle', payload)

                setPayloadView(sent, payload)
                setPayloadView(received, data)

                if (data.error) {
                    appendOutput('Auth', data.message, true)
                    return
                }

                appendOutput('Auth', data.message)
            } catch (error) {
                appendOutput('Error', error.message, true)
            }
        })

        logBtn.addEventListener('click', async function () {
            const payload = {
                action: 'log',
                log: {
                    name: 'event',
                    data: 'Some kind of data'
                }
            }

            try {
                const data = await postJSON('/handle', payload)

                setPayloadView(sent, payload)
                setPayloadView(received, data)

                if (data.error) {
                    appendOutput('Logger RPC', data.message, true)
                    return
                }

                appendOutput('Logger RPC', data.message)
            } catch (error) {
                appendOutput('Error', error.message, true)
            }
        })

        mailBtn.addEventListener('click', async function () {
            const payload = {
                action: 'mail',
                mail: {
                    from: 'sender@example.com',
                    to: 'recipient@example.com',
                    subject: 'Test Mail',
                    message: 'This is a test mail from the front-end.'
                }
            }

            try {
                const data = await postJSON('/handle', payload)

                setPayloadView(sent, payload)
                setPayloadView(received, data)

                if (data.error) {
                    appendOutput('Mail', data.message, true)
                    return
                }

                appendOutput('Mail', data.message)
            } catch (error) {
                appendOutput('Error', error.message, true)
            }
        })

        logGrpcBtn.addEventListener('click', async function () {
            const payload = {
                action: 'log',
                log: {
                    name: 'event',
                    data: 'Some kind of gRPC data'
                }
            }

            try {
                const data = await postJSON('/log-grpc', payload)

                setPayloadView(sent, payload)
                setPayloadView(received, data)

                if (data.error) {
                    appendOutput('Logger gRPC', data.message, true)
                    return
                }

                appendOutput('Logger gRPC', data.message)
            } catch (error) {
                appendOutput('Error', error.message, true)
            }
        })
    </script>
{{end}}
